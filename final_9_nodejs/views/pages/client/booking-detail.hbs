{{!-- <!-- Book-body -->
<div class="container-fiuld mt-5" style="background: #fafafa;">
    <div class="container">
        <div class="row p-3">

            <!-- ========== LEFT: Flight Information ========== -->
            <div class="col-lg-8 col-sm-12 col-12 p-3 pe-4">
                <div class="row p-4"
                    style="background: #fff; box-shadow:0px 4px 16px rgba(17,34,17,0.05); border-radius:12px;">

                    <!-- Row 1 -->
                    <div class="row mt-3">
                        <div class="col-9 p-0">
                            <h2>{{flightData.airlineInfo.airline_name}}</h2>
                        </div>
                        <div class="col-3 text-end">
                            <strong class="fs-3" style="color:#ff8682;">
                                {{formatCurrency flightData.classPricing}}
                            </strong>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="row mt-3">
                        <div class="col-10 fw-bold p-0">
                            <p>Departure on {{splitString flightData.departure_datetime " " 0}}</p>
                        </div>
                        <div class="col-2 fs-5">
                            <p>{{calculateDuration flightData.departure_datetime flightData.arrival_datetime}}</p>
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="row mt-3 d-flex align-items-center">
                        <div class="col-md-4">
                            <div class="row p-2 d-flex align-items-center"
                                style="border:0.5px solid #8DD3BB; border-radius:8px;">
                                <div class="col-4 text-center">
                                    <img src="{{flightData.airlineInfo.airline_logo}}"
                                         style="width:80px; height:65px;">
                                </div>
                                <div class="col-8 text-center">
                                    <h2 class="fs-5 pt-2">{{flightData.airline_name}}</h2>
                                    <p class="desc">Airbus A{{flightData.flight_id}}</p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8 text-center">
                            <img class="p-3" src="../../img/ticket_info/plane.svg">
                            <img class="p-3" src="../../img/ticket_info/wifi.svg">
                            <img class="p-3" src="../../img/ticket_info/stopwatch.svg">
                            <img class="p-3" src="../../img/ticket_info/fast-food.svg">
                            <img class="ps-3" src="../../img/ticket_info/round-seat.svg">
                        </div>
                    </div>

                    <!-- Row 4 -->
                    <div class="row mt-3 d-flex justify-content-between px-5 py-4">
                        <div class="col-4 text-center">
                            <p class="fs-4 fw-bold">
                                {{splitString flightData.departure_datetime ' ' 1}}
                            </p>
                            <p style="opacity:0.8;">{{flightData.to.airport_name}}</p>
                        </div>

                        <div class="col-4 text-center">
                            <img src="../../img/ticket_info/plane.svg">
                        </div>

                        <div class="col-4 text-center">
                            <p class="fs-4 fw-bold">
                                {{splitString flightData.arrival_datetime ' ' 1}}
                            </p>
                            <p style="opacity:0.8;">
                                {{flightData.from.airport_name}}
                            </p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ========== RIGHT: QR PAYMENT ========== -->
            <div class="col-lg-4 col-sm-12 col-12 p-3">
                <div class="row p-4"
                    style="background:#fff; box-shadow:0px 4px 16px rgba(17,34,17,0.05); border-radius:12px;">

                    <!-- Ticket Info -->
                    <div class="row d-flex align-items-center mb-4">
                        <div class="col-5">
                            <img src="../../img/ticket_info/ticket.svg" width="80">
                        </div>
                        <div class="col-7">
                            <span>{{flightData.class}}</span>
                            <p class="fw-bold m-0">
                                {{flightData.airlineInfo.airline_name}}<br>
                                Airbus A{{flightData.flight_id}}
                            </p>
                        </div>
                    </div>
                    <div class="qr-container text-center"
                    style="background:#fff; border-radius:12px; padding:25px;">

                    <h4 class="fw-bold mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n MoMo</h4>

                    <img id="qr-image"
                        style="width:280px; display:none; margin:auto; border:1px solid #ccc; padding:10px; border-radius:10px;">

                    <p class="mt-3" style="font-size:14px;">D√πng app MoMo ƒë·ªÉ thanh to√°n</p>

                    <!-- Checkbox x√°c nh·∫≠n -->
                    <div id="transfer-done" style="margin-top:20px;">
                        <input id="confirm-checkbox" type="checkbox" style="transform: scale(1.2); margin-right:10px;">
                        <label for="confirm-checkbox" style="font-size:15px;">T√¥i ƒë√£ chuy·ªÉn kho·∫£n xong</label>
                    </div>


                    <!-- N√∫t t·∫°o QR -->
                    <button type="button" onclick="showQR()" id="pay-button"
                        style="margin-top:25px; width:100%; padding:12px;
                            border:1px solid #333; border-radius:6px;
                            background:#fafafa; font-size:16px; font-weight:bold;">
                        Hi·ªÉn th·ªã m√£ QR
                    </button>

                    {{!-- <!-- N√∫t g·ª≠i x√°c nh·∫≠n thanh to√°n -->
                    <button type="button" id="confirm-button" onclick="confirmPayment()"
                        style="margin-top:15px; width:100%; padding:12px; display:none;
                            border:1px solid #28a745; border-radius:6px;
                            background:#e9ffe9; font-size:16px; font-weight:bold; color:#1e7e34;">
                        X√°c nh·∫≠n ƒë√£ thanh to√°n
                    </button> --}}

                </div>


                </div>
            </div>

        </div>
    </div>
</div> --}}
<div class="container-fluid mt-5" style="background:#fafafa;">
  <div class="container">
    <div class="row p-3">

      <!-- LEFT SIDE -->
      <div class="col-lg-8 col-sm-12 p-4">
        <div class="p-4" 
             style="background:#fff; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,0.05);">

          <h3 class="fw-bold mb-3">Th√¥ng tin v√©</h3>

          <div class="row mt-4">

            <!-- Logo -->
            <div class="col-12 text-center mb-4">
              <img src="{{flightData.airlineInfo.airline_logo}}" 
                   style="width:120px;">
            </div>

            <!-- M√£ chuy·∫øn bay -->
            <div class="col-4 mb-3">
              <label class="fw-bold">M√£ chuy·∫øn bay:</label>
              <p>{{flightData._id}}</p> 
            </div>

            <!-- M√£ v√© -->
            <div class="col-4 mb-3">
              <label class="fw-bold">M√£ v√©:</label>
              <p>{{ticket._id}}</p>    
            </div>

            <!-- M√£ ng∆∞·ªùi d√πng -->
            <div class="col-4 mb-3">
              <label class="fw-bold">M√£ ng∆∞·ªùi d√πng:</label>
              <p>{{user._id}}</p>
            </div>

            <!-- T·ªïng ti·ªÅn -->
            <div class="col-12 mt-4 p-3"
                 style="background:#f6f6f6; border-radius:8px; border-left:5px solid #8DD3BB;">
              <h4 class="fw-bold m-0">
                T·ªïng ti·ªÅn: {{totalPrice}}
              </h4>
            </div>

          </div>

        </div>
      </div>

      <!-- ========== RIGHT: QR PAYMENT ========== -->
            <div class="col-lg-4 col-sm-12 col-12 p-3">
                <div class="row p-4"
                    style="background:#fff; box-shadow:0px 4px 16px rgba(17,34,17,0.05); border-radius:12px;">

                    <!-- Ticket Info -->
                    <div class="row d-flex align-items-center mb-4">
                        <div class="col-5">
                            <img src="/img/ticket_info/ticket.svg" width="80">
                        </div>
                        <div class="col-7">
                            <span>{{flightData.class}}</span>
                            <p class="fw-bold m-0">
                                {{flightData.airlineInfo.airline_name}}<br>
                                Airbus A{{flightData.flight_id}}
                            </p>
                        </div>
                    </div>
                    <div class="qr-container text-center"
                    style="background:#fff; border-radius:12px; padding:25px;">

                    <h4 class="fw-bold mb-3">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n MoMo</h4>

                    <img id="qr-image"
                        style="width:280px; display:none; margin:auto; border:1px solid #ccc; padding:10px; border-radius:10px;">

                    <p class="mt-3" style="font-size:14px;">D√πng app MoMo ƒë·ªÉ thanh to√°n</p>

                    <!-- Checkbox x√°c nh·∫≠n -->
                    <div id="transfer-done" style="margin-top:20px;">
                        <input id="confirm-checkbox" type="checkbox" style="transform: scale(1.2); margin-right:10px;">
                        <label for="confirm-checkbox" style="font-size:15px;">T√¥i ƒë√£ chuy·ªÉn kho·∫£n xong</label>
                    </div>


                    <!-- N√∫t t·∫°o QR -->
                    <button type="button" onclick="showQR()" id="pay-button"
                        style="margin-top:25px; width:100%; padding:12px;
                            border:1px solid #333; border-radius:6px;
                            background:#fafafa; font-size:16px; font-weight:bold;">
                        Hi·ªÉn th·ªã m√£ QR
                    </button>

                    {{!-- <!-- N√∫t g·ª≠i x√°c nh·∫≠n thanh to√°n -->
                    <button type="button" id="confirm-button" onclick="confirmPayment()"
                        style="margin-top:15px; width:100%; padding:12px; display:none;
                            border:1px solid #28a745; border-radius:6px;
                            background:#e9ffe9; font-size:16px; font-weight:bold; color:#1e7e34;">
                        X√°c nh·∫≠n ƒë√£ thanh to√°n
                    </button> --}}

                </div>


                </div>
            </div>
  </div>
</div>


<script>
async function showQR() {
    try {
        const amount = {{totalPrice}};

        const res = await fetch("/payment/momo-qr", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
        });

        const data = await res.json();

        if (data.qrCodeUrl) {
            const qrImgUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="
                             + encodeURIComponent(data.qrCodeUrl);

            document.getElementById("qr-image").src = qrImgUrl;
            document.getElementById("qr-image").style.display = "block";
        } else {
            alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c m√£ QR!");
        }
    } catch (err) {
        console.error(err);
        alert("L·ªói h·ªá th·ªëng!");
    }
}


document.getElementById("confirm-checkbox").addEventListener("change", async function () {
    if (!this.checked) return;

    const ticketId = "{{ticket._id}}";

    try {
        const res = await fetch("/payment/pending", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticketId })
        });

        const data = await res.json();

        if (data.success) {
            alert("‚è≥ H·ªá th·ªëng ƒë√£ ghi nh·∫≠n y√™u c·∫ßu. Vui l√≤ng ch·ªù admin x√°c nh·∫≠n!");
        } else {
            alert("‚ùå G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i!");
        }
    } catch (err) {
        console.error(err);
        alert("‚ö† Kh√¥ng th·ªÉ k·∫øt n·ªëi server!");
    }
});


// ==============================
// ‚ö° CH·ªà GI·ªÆ L·∫†I 1 ƒêO·∫†N POLLING
// ==============================

document.addEventListener("DOMContentLoaded", () => {
    const ticketId = "{{ticket._id}}";

    console.log("‚è≥ B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i v√©:", ticketId);

    setInterval(async () => {
        try {
            const res = await fetch(`/payment/status/${ticketId}`);
            const data = await res.json();

            console.log("üîç Tr·∫°ng th√°i v√©:", data.status);

            if (data.status === "paid") {
                alert("üéâ Thanh to√°n th√†nh c√¥ng!");
                window.location.href = "/ticket-info/" + ticketId;
            }
        } catch (err) {
            console.error("L·ªói g·ªçi API tr·∫°ng th√°i:", err);
        }
    }, 3000);
});
</script>

