<style>
body {
    margin: 0;
    padding-top: 90px;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background:
        linear-gradient(rgba(255,255,255,0.88), rgba(255,255,255,0.88)),
        url("https://images.unsplash.com/photo-1506744038136-46273834b3fb");
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
}

/* =================== CARD =================== */
.card-box {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(8px);
    border-radius: 16px;
    box-shadow: 0 12px 35px rgba(0,0,0,0.12);
}

/* =================== TITLE =================== */
.section-title {
    font-weight: 700;
    border-left: 5px solid #8DD3BB;
    padding-left: 12px;
    margin-bottom: 20px;
}

/* =================== PRICE =================== */
.total-price {
    background: linear-gradient(90deg, #8DD3BB, #cdefff);
    color: #000;
    border-radius: 12px;
    font-weight: 700;
}

/* =================== QR =================== */
.qr-box {
    border: 1px dashed #ccc;
    border-radius: 14px;
    padding: 24px;
}

#qr-image {
    width: 280px;
    border-radius: 14px;
    padding: 12px;
    background: #fff;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* =================== BUTTON =================== */
.btn-qr {
    background: linear-gradient(90deg, #ffeb3b, #ffc107);
    font-weight: 700;
    border-radius: 40px;
    padding: 12px;
    transition: 0.3s;
}

.btn-qr:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(255,193,7,0.6);
}
</style>

<div class="container-fluid mt-5">
  <div class="container">
    <div class="row g-4">

      <!-- ================= LEFT ================= -->
      <div class="col-lg-8 col-sm-12">
        <div class="card-box p-4">

          <h3 class="section-title">üé´ Th√¥ng tin v√©</h3>

          <div class="text-center mb-4">
            <img src="{{flightData.airlineInfo.airline_logo}}" style="width:120px">
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="fw-bold">M√£ chuy·∫øn bay</label>
              <p>{{flightData._id}}</p>
            </div>

            <div class="col-md-4 mb-3">
              <label class="fw-bold">M√£ v√©</label>
              <p>{{ticket._id}}</p>
            </div>

            <div class="col-md-4 mb-3">
              <label class="fw-bold">M√£ ng∆∞·ªùi d√πng</label>
              <p>{{user._id}}</p>
            </div>
          </div>

          <div class="total-price p-4 mt-4">
            <h4 class="m-0">üí∞ T·ªïng ti·ªÅn: {{totalPrice}}</h4>
          </div>

        </div>
      </div>

      <!-- ================= RIGHT ================= -->
      <div class="col-lg-4 col-sm-12">
        <div class="card-box p-4">

          <div class="d-flex align-items-center mb-4">
            <img src="/img/ticket_info/ticket.svg" width="70">
<div class="ms-3">
              <span class="text-muted">{{flightData.class}}</span>
              <p class="fw-bold m-0">
                {{flightData.airlineInfo.airline_name}}<br>
                Airbus A{{flightData.flight_id}}
              </p>
            </div>
          </div>

          <div class="qr-box text-center">
            <h5 class="fw-bold mb-3">üì± Qu√©t QR thanh to√°n MoMo</h5>

            <img id="qr-image" style="display:none; margin:auto;">

            <p class="mt-3 text-muted" style="font-size:14px;">
              M·ªü ·ª©ng d·ª•ng MoMo ƒë·ªÉ qu√©t m√£
            </p>

            <div class="form-check mt-3">
              <input class="form-check-input" id="confirm-checkbox" type="checkbox">
              <label class="form-check-label">
                T√¥i ƒë√£ chuy·ªÉn kho·∫£n xong
              </label>
            </div>

            <button type="button"
                    onclick="showQR()"
                    id="pay-button"
                    class="btn btn-qr w-100 mt-4">
              Hi·ªÉn th·ªã m√£ QR
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>


<script>
async function showQR() {
    try {
        const amount = {{totalPrice}};

        const res = await fetch("/payment/momo-qr", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
        });

        const data = await res.json();

        if (data.qrCodeUrl) {
            const qrImgUrl = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="
                             + encodeURIComponent(data.qrCodeUrl);

            document.getElementById("qr-image").src = qrImgUrl;
            document.getElementById("qr-image").style.display = "block";
        } else {
            alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c m√£ QR!");
        }
    } catch (err) {
        console.error(err);
        alert("L·ªói h·ªá th·ªëng!");
    }
}


document.getElementById("confirm-checkbox").addEventListener("change", async function () {
    if (!this.checked) return;

    const ticketId = "{{ticket._id}}";

    try {
        const res = await fetch("/payment/pending", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticketId })
        });

        const data = await res.json();

        if (data.success) {
            alert("‚è≥ H·ªá th·ªëng ƒë√£ ghi nh·∫≠n y√™u c·∫ßu. Vui l√≤ng ch·ªù admin x√°c nh·∫≠n!");
        } else {
            alert("‚ùå G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i!");
        }
    } catch (err) {
        console.error(err);
        alert("‚ö† Kh√¥ng th·ªÉ k·∫øt n·ªëi server!");
    }
});


// ==============================
// ‚ö° CH·ªà GI·ªÆ L·∫†I 1 ƒêO·∫†N POLLING
// ==============================

document.addEventListener("DOMContentLoaded", () => {
    const ticketId = "{{ticket._id}}";
console.log("‚è≥ B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i v√©:", ticketId);

    setInterval(async () => {
        try {
            const res = await fetch(`/payment/status/${ticketId}`);
            const data = await res.json();

            console.log("üîç Tr·∫°ng th√°i v√©:", data.status);

            if (data.status === "paid") {
                alert("üéâ Thanh to√°n th√†nh c√¥ng!");
                window.location.href = "/ticket-info/" + ticketId;
            }
        } catch (err) {
            console.error("L·ªói g·ªçi API tr·∫°ng th√°i:", err);
        }
    }, 3000);
});
</script>
